var Audio;(()=>{"use strict";var e={};(()=>{var t=e;Object.defineProperty(t,"__esModule",{value:!0}),t.AudioPlayer=void 0;var a=function(){function e(e){this.state={delay:{time:.9,feedback:0},melody:[[],[],[],[],[],[],[],[]],envelope:{attack:0,decay:.1,sustain:.4,release:.2},lfo:{frequency:10,intensity:9,wave:"sine"},oscillator:{waveform:"sine",coarseFrequency:0,fineFrequency:0,octave:0}},this.viewUpdateCallback=e,this.currentChord=0,this.playing=!1,this.bpm=300,this.drumPatterns=new Map([["kick",Array(16).fill(!1)],["hihat",Array(16).fill(!1)],["snare",Array(16).fill(!1)]]),this.intervalIds=[],this.audioCtx}return e.prototype.playKick=function(e){var t=this.audioCtx.createGain();t.gain.setValueAtTime(1,this.audioCtx.currentTime),t.connect(this.audioCtx.destination),t.gain.exponentialRampToValueAtTime(.01,this.audioCtx.currentTime+.5);var a=this.audioCtx.createOscillator();a.type="sine",a.frequency.setValueAtTime(150,this.audioCtx.currentTime),a.connect(t),a.frequency.exponentialRampToValueAtTime(.01,this.audioCtx.currentTime+.5),a.start(e*(6e4/this.bpm)/1e3),a.stop(e*(6e4/this.bpm)/1e3+.2)},e.prototype.playSnare=function(e){for(var t=.2*this.audioCtx.sampleRate,a=this.audioCtx.createBuffer(1,t,this.audioCtx.sampleRate),i=a.getChannelData(0),s=0;s<t;s++)i[s]=2*Math.random()-1;var o=this.audioCtx.createBufferSource();o.buffer=a;var r=this.audioCtx.createGain();r.gain.setValueAtTime(1,this.audioCtx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.audioCtx.currentTime+.2),o.connect(r),r.connect(this.audioCtx.destination),o.start(e*(6e4/this.bpm)/1e3)},e.prototype.playHihat=function(e){for(var t=.1*this.audioCtx.sampleRate,a=this.audioCtx.createBuffer(1,t,this.audioCtx.sampleRate),i=a.getChannelData(0),s=0;s<t;s++)i[s]=2*Math.random()-1;var o=this.audioCtx.createBufferSource();o.buffer=a;var r=this.audioCtx.createGain();r.gain.setValueAtTime(1,this.audioCtx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.audioCtx.currentTime+.1),o.connect(r),r.connect(this.audioCtx.destination),o.start(e*(6e4/this.bpm)/1e3)},e.prototype.invokeInterval=function(e){for(var t=this,a=e;this.playing&&a*(6e4/this.bpm)<1e3*this.audioCtx.currentTime+75;)this.state.melody[a%8].forEach((function(e){var i=t.audioCtx.createGain(),s=a*(6e4/t.bpm)/1e3;i.gain.setValueAtTime(0,s),i.gain.linearRampToValueAtTime(.8,s+t.state.envelope.attack),i.gain.linearRampToValueAtTime(.8*t.state.envelope.sustain,s+t.state.envelope.attack+t.state.envelope.decay),i.gain.setValueAtTime(.8*t.state.envelope.sustain,s+.2-t.state.envelope.release),i.gain.linearRampToValueAtTime(0,s+.2),i.connect(t.audioCtx.destination);var o=t.audioCtx.createOscillator();if(o.type=t.state.oscillator.waveform,t.state.delay.feedback>0){var r=t.audioCtx.createDelay(1);r.delayTime.setValueAtTime(t.state.delay.time,t.audioCtx.currentTime);var n=t.audioCtx.createGain();n.gain.setValueAtTime(t.state.delay.feedback,t.audioCtx.currentTime),r.connect(n),n.connect(r),i.connect(r),r.connect(t.audioCtx.destination)}var c=e*Math.pow(2,t.state.oscillator.octave)*(1+t.state.oscillator.coarseFrequency+t.state.oscillator.fineFrequency/100);o.frequency.setValueAtTime(c,t.audioCtx.currentTime),o.connect(i);var u=t.audioCtx.createOscillator();console.log(t.state.lfo.wave),u.type=t.state.lfo.wave,u.frequency.setValueAtTime(t.state.lfo.frequency,t.audioCtx.currentTime);var l=t.audioCtx.createGain();l.gain.setValueAtTime(t.state.lfo.intensity,t.audioCtx.currentTime),u.connect(l),l.connect(o.frequency),o.start(a*(6e4/t.bpm)/1e3),o.stop(a*(6e4/t.bpm)/1e3+.2),u.start()})),this.drumPatterns.get("kick")[a%16]&&this.playKick(a),this.drumPatterns.get("snare")[a%16]&&this.playSnare(a),this.drumPatterns.get("hihat")[a%16]&&this.playHihat(a),this.viewUpdateCallback(a),a+=1;this.intervalIds.push(setTimeout((function(){t.invokeInterval(a)}),50))},e.prototype.clearIntervals=function(){for(var e=0,t=this.intervalIds;e<t.length;e++){var a=t[e];clearTimeout(a)}},e.prototype.processAudioCommand=function(e){"play"===e?(void 0===this.audioCtx&&(this.audioCtx=new AudioContext),void 0!==this.audioCtx&&(this.audioCtx.close(),this.audioCtx=new AudioContext),this.playing||(this.playing=!0,this.invokeInterval(this.currentChord))):"pause"===e?(this.playing=!1,this.clearIntervals(),void 0!==this.audioCtx&&(this.audioCtx.close(),this.audioCtx=new AudioContext)):"reset"===e&&(this.playing=!1,this.clearIntervals(),this.currentChord=0,void 0!==this.audioCtx&&(this.audioCtx.close(),this.audioCtx=new AudioContext))},e.prototype.stepEngine=function(e){var t=e.tag,a=e.message;switch(t){case"bpm":var i=JSON.parse(a);this.bpm=i;break;case"delay":var s=JSON.parse(a);switch(s.param){case"time":this.state.delay.time=s.value;break;case"feedback":this.state.delay.feedback=s.value}break;case"melody":var o=JSON.parse(a);this.state.melody=o;break;case"audio_command":var r=JSON.parse(a);this.processAudioCommand(r);break;case"envelope":var n=JSON.parse(a);switch(n.param){case"attack":this.state.envelope.attack=n.value;break;case"decay":this.state.envelope.decay=n.value;break;case"release":this.state.envelope.release=n.value;break;case"sustain":this.state.envelope.sustain=n.value}break;case"oscillator":var c=JSON.parse(a);switch(console.log(c),c.param){case"waveform":this.state.oscillator.waveform=c.value;break;case"coarseFrequency":console.log("coarseFrequency: "+c.value),this.state.oscillator.coarseFrequency=c.value;break;case"fineFrequency":this.state.oscillator.fineFrequency=c.value;break;case"octave":this.state.oscillator.octave=c.value}break;case"lfo":var u=JSON.parse(a);switch(console.log(a),u.param){case"frequency":this.state.lfo.frequency=u.value;break;case"intensity":this.state.lfo.intensity=u.value;break;case"waveType":this.state.lfo.wave=u.value,console.log("set wave to "+this.state.lfo.wave)}break;default:console.warn("Unknown message tag: ".concat(t))}},e.prototype.toggleDrumPatternAt=function(e,t){this.drumPatterns.get(e)[t]=!this.drumPatterns.get(e)[t]},e.prototype.updateBpm=function(e){this.bpm=e},e}();t.AudioPlayer=a})(),Audio=e})();